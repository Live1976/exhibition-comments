<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collective Domain - Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, system-ui, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #000;
            color: #fff;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 24px;
            font-weight: 400;
        }

        .login-section {
            background: white;
            padding: 40px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 100px auto;
        }

        .login-section h2 {
            margin-bottom: 20px;
            font-weight: 400;
            text-align: center;
        }

        .admin-panel {
            display: none;
        }

        .comment-controls {
            background: white;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-btn {
            padding: 8px 16px;
            background: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .filter-btn.active {
            background: #007cba;
            color: white;
            border-color: #007cba;
        }

        .filter-btn:hover {
            background: #e0e0e0;
        }

        .filter-btn.active:hover {
            background: #005a8b;
        }

        .ai-analysis {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #b3d9ff;
        }

        .ai-analysis h3 {
            margin-bottom: 15px;
            color: #0066cc;
        }

        .prompt-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .prompt-stat {
            background: white;
            padding: 8px 12px;
            border-radius: 3px;
            border: 1px solid #ccc;
            font-size: 12px;
        }

        .prompt-type {
            font-weight: bold;
            color: #0066cc;
        }

        .ai-comment-item {
            border-left: 4px solid #4CAF50;
        }

        .human-comment-item {
            border-left: 4px solid #2196F3;
        }

        .comment-meta {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .comment-list {
            margin-top: 20px;
        }

        .comment-item {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: relative;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .comment-author {
            font-weight: 500;
        }

        .comment-time {
            color: #999;
            font-size: 14px;
        }

        .comment-content {
            margin-bottom: 15px;
        }

        .comment-actions {
            text-align: right;
        }

        .delete-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }

        .approve-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 5px;
        }

        .pending {
            background: #fffde7;
        }

        .pending::before {
            content: "PENDING REVIEW";
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff9800;
            color: white;
            padding: 3px 8px;
            font-size: 12px;
            border-radius: 3px;
        }

        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            padding: 12px 20px;
            background: #000;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }

        .logout-btn {
            background: transparent;
            border: 1px solid white;
            width: auto;
            font-size: 14px;
            padding: 5px 10px;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .stat-number {
            font-size: 36px;
            font-weight: 300;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .ai-section {
            margin-top: 30px;
            background: white;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .ai-section h2 {
            margin-bottom: 20px;
            font-weight: 400;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .save-btn {
            width: auto;
            margin-right: 10px;
        }

        .ai-preview {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            border: 1px solid #eee;
            min-height: 50px;
        }

        .ai-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .ai-controls button {
            width: auto;
            padding: 10px 15px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .frequency-setting {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .frequency-setting h3 {
            margin-bottom: 10px;
            color: #1976d2;
        }

        @media (max-width: 768px) {
            .ai-controls {
                flex-direction: column;
            }
            
            .ai-controls button {
                width: 100%;
            }
            
            .filter-buttons {
                flex-direction: column;
            }
            
            .prompt-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Section -->
    <div class="login-section" id="loginSection">
        <h2>ADMIN LOGIN</h2>
        <form id="loginForm">
            <input type="text" id="username" placeholder="Username" required>
            <input type="password" id="password" placeholder="Password" required>
            <button type="submit">LOGIN</button>
        </form>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <header>
            <h1>EXHIBITION COMMENTS ADMIN</h1>
            <button class="logout-btn" id="logoutBtn">LOGOUT</button>
        </header>
        
        <div class="container">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalComments">0</div>
                    <div class="stat-label">TOTAL COMMENTS</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingComments">0</div>
                    <div class="stat-label">PENDING REVIEW</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="aiGenerated">0</div>
                    <div class="stat-label">AI GENERATED</div>
                </div>
            </div>
            
            <div class="comment-controls">
                <div class="filter-buttons">
                    <button id="showAll" class="filter-btn active">Show All Comments</button>
                    <button id="showAI" class="filter-btn">AI Comments Only</button>
                    <button id="showHuman" class="filter-btn">Human Comments Only</button>
                </div>
                <div class="ai-analysis" id="aiAnalysis" style="display: none;">
                    <!-- AI analysis will appear here -->
                </div>
            </div>
            
            <div class="comment-list" id="commentList">
                <!-- Comments will be loaded here -->
            </div>
            
            <div class="ai-section">
                <h2>Advanced AI Comment Generation</h2>
                
                <div class="control-group">
                    <label>OpenAI API Key:</label>
                    <input type="password" id="openaiApiKey" placeholder="sk-...">
                </div>

                <div class="frequency-setting">
                    <h3>Auto-Generation Settings</h3>
                    <p>Current: Every 15-25 minutes (3-4 comments per hour)</p>
                    <p>Exhibition Schedule: 5 days × 8 hours × ~20 comments = ~100 total comments</p>
                    <p>System uses 20+ diverse prompt templates to avoid repetition</p>
                </div>

                <div class="ai-controls">
                    <button id="generatePreview" class="save-btn">Generate Preview</button>
                    <button id="generateBatch" class="save-btn">Generate 5 Comments</button>
                    <button id="enableAiComments" style="background: #4CAF50;">Enable Auto Generation</button>
                    <button id="testDiversity" class="save-btn">Test Diversity (10 samples)</button>
                </div>
                
                <div class="ai-preview" id="aiPreview">
                    AI-generated comments will appear here...
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC_9YXNAYdFjmqK2iNKrra76zd05Nd61Iw",
            authDomain: "exhibition-comments.firebaseapp.com",
            projectId: "exhibition-comments",
            storageBucket: "exhibition-comments.firebasestorage.app",
            messagingSenderId: "166867670609",
            appId: "1:166867670609:web:7e2009858a5e4ecd300a70",
            measurementId: "G-D89J84MCH6"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Admin credentials
        const ADMIN_USERNAME = "admin";
        const ADMIN_PASSWORD = "password123";

        // DOM elements
        const loginSection = document.getElementById('loginSection');
        const adminPanel = document.getElementById('adminPanel');
        const loginForm = document.getElementById('loginForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const commentList = document.getElementById('commentList');
        const openaiApiKey = document.getElementById('openaiApiKey');
        const generatePreview = document.getElementById('generatePreview');
        const generateBatch = document.getElementById('generateBatch');
        const enableAiComments = document.getElementById('enableAiComments');
        const testDiversity = document.getElementById('testDiversity');
        const aiPreview = document.getElementById('aiPreview');
        const showAll = document.getElementById('showAll');
        const showAI = document.getElementById('showAI');
        const showHuman = document.getElementById('showHuman');
        const aiAnalysis = document.getElementById('aiAnalysis');

        // Realistic visitor names - more authentic and diverse
        const visitorNames = [
            "Maya", "Alex", "Sam", "K", "Jo", "Riley", "Casey", "M.", "R.K.", "visitor47",
            "anon", "someone", "A.", "kim", "lee", "Pat", "sage", "river", "Sky", "Morgan",
            "J.L.", "anonymous", "guest", "nina", "Kris", "Quinn", "Ash", "Dana", "Lou", "Sasha"
        ];

        // AI generation state with randomized timing
        let aiInterval = null;
        let aiGeneratedCount = 0;
        let lastPromptUsed = null;
        let usedPrompts = [];

        // Global variables for filtering
        let allComments = [];
        let currentFilter = 'all';

        // Real visitor reaction fragments from Schneider's Die Familie Schneider
        const realVisitorReactions = [
            "a queasy sense of trepidation set in",
            "I feel oddly abandoned by this",
            "primitive fears of monsters under the bed",
            "sickening sense of déjà vu",
            "narrow corridors are claustrophobic", 
            "grimy flock wallpaper choked the rooms",
            "when is the last time you thought twice about letting a door swing shut",
            "realised, with a shudder, that you were not alone",
            "moving like a ghost revisiting the scene of its own murder",
            "the silence between the walls is almost tangible",
            "beside himself. He walks through the house next to himself",
            "I keep thinking I've been in these rooms before",
            "everything looks normal but feels wrong",
            "the proportions of the rooms were not quite right",
            "body somehow knew something wasn't right",
            "immersion walked hand in hand with estrangement"
        ];

        // Diverse prompt templates based on real visitor reactions
        const promptTemplates = [
            {
                type: "initial_fear",
                template: `You just entered an unsettling art installation. You're feeling nervous and uncertain. Write a 1-2 sentence visitor comment expressing immediate unease. Use simple, natural language. Focus on first impressions and physical sensations.`
            },
            {
                type: "spatial_confusion", 
                template: `You're walking through rooms that feel familiar yet wrong. Write a brief comment about spatial disorientation and the feeling that proportions aren't quite right. Be conversational and personal.`
            },
            {
                type: "questioning",
                template: `You're questioning your own perception and memory. Write a comment as a rhetorical question, wondering about what you're experiencing. Start with "When was the last time..." or "Why does..." or "How is it that..."`
            },
            {
                type: "body_response",
                template: `Your body is reacting to this space before your mind catches up. Write about physical sensations - queasy feeling, trepidation, shuddering. Keep it immediate and visceral.`
            },
            {
                type: "deja_vu",
                template: `You're experiencing strong déjà vu or false memory. Write about feeling like you've been here before, or seeing the same thing twice. Express confusion about reality and memory.`
            },
            {
                type: "isolation",
                template: `You feel alone and abandoned in this space. Write about silence, emptiness, or being cut off from the outside world. Use words that convey solitude and disconnection.`
            },
            {
                type: "watching",
                template: `You feel like you're being watched or observed. Write a brief comment about the feeling of eyes on you, or sensing invisible presence. Express subtle paranoia.`
            },
            {
                type: "fragments",
                template: `Express your experience in short, fragmented thoughts. Write 2-4 word phrases separated by periods. Focus on immediate impressions: "The silence. The repetition. Can't shake it."`
            },
            {
                type: "normality_wrong",
                template: `Everything looks normal but feels completely wrong. Write about the uncanny gap between appearance and feeling. Contrast the ordinary with the unsettling.`
            },
            {
                type: "time_confusion",
                template: `Time feels strange here - too slow, too fast, or suspended. Write about temporal disorientation or feeling stuck in a moment. Be poetic but grounded.`
            },
            {
                type: "escape_impulse",
                template: `You want to leave but feel compelled to stay. Write about the tension between curiosity and fear, being drawn in despite unease. Express conflicted feelings.`
            },
            {
                type: "repetition",
                template: `You're noticing disturbing repetitions or patterns. Write about seeing the same thing multiple times or feeling trapped in a loop. Express growing unease.`
            },
            {
                type: "memory_trigger",
                template: `This place reminds you of somewhere from your past - childhood home, hospital, school. Write about unwanted memories or associations this space triggers.`
            },
            {
                type: "ghost_feeling",
                template: `You feel like a ghost moving through someone else's space. Write about feeling invisible, insubstantial, or like you don't belong here. Use ethereal language.`
            },
            {
                type: "rational_fear",
                template: `Your rational mind is fighting primitive fear. Write about the struggle between logic and instinct, trying to stay calm while feeling increasingly uneasy.`
            },
            {
                type: "details_wrong",
                template: `Small details feel off - shadows, sounds, textures. Write about noticing subtle wrongness in ordinary things. Focus on one specific detail that disturbs you.`
            },
            {
                type: "breath_space",
                template: `The air feels thick, stale, or hard to breathe. Write about atmospheric pressure, claustrophobia, or feeling suffocated. Use sensory language.`
            },
            {
                type: "conversation",
                template: `Write as if talking to a friend about this experience. Use casual language: "I swear..." "You know when..." "It's like..." Keep it conversational and relatable.`
            },
            {
                type: "art_student",
                template: `You're an art student trying to analyze what you're experiencing. Write about the work's effect on you while struggling to maintain critical distance. Balance analysis with emotion.`
            },
            {
                type: "tourist_brief",
                template: `You're a tourist with limited time, quickly moving through. Write a rushed impression - immediate, surface-level but still affected. Use present tense urgency.`
            }
        ];

        // Login functionality
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                loginSection.style.display = 'none';
                adminPanel.style.display = 'block';
                loadComments();
                
                // Load saved API key
                const savedApiKey = localStorage.getItem('openaiApiKey');
                if (savedApiKey) {
                    openaiApiKey.value = savedApiKey;
                }
            } else {
                alert('Invalid credentials');
            }
        });

        // Logout functionality
        logoutBtn.addEventListener('click', function() {
            loginSection.style.display = 'block';
            adminPanel.style.display = 'none';
            document.getElementById('loginForm').reset();
        });

        // Load comments with filtering capability
        function loadComments(filter = 'all') {
            db.collection('comments')
                .orderBy('timestamp', 'desc')
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        commentList.innerHTML = '<p style="text-align: center; padding: 20px;">No comments yet.</p>';
                        return;
                    }
                    
                    // Store all comments
                    allComments = [];
                    snapshot.forEach(doc => {
                        allComments.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Apply filter and render
                    renderComments(filter);
                    updateStats();
                    
                    if (filter === 'ai') {
                        showAIAnalysis();
                    } else {
                        aiAnalysis.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error loading comments:', error);
                    commentList.innerHTML = `<p>Error loading comments: ${error.message}</p>`;
                });
        }

        // Render comments based on filter
        function renderComments(filter) {
            let filteredComments = allComments;
            
            if (filter === 'ai') {
                filteredComments = allComments.filter(comment => comment.isAi);
            } else if (filter === 'human') {
                filteredComments = allComments.filter(comment => !comment.isAi);
            }
            
            if (filteredComments.length === 0) {
                const filterText = filter === 'ai' ? 'AI' : filter === 'human' ? 'human' : '';
                commentList.innerHTML = `<p style="text-align: center; padding: 20px;">No ${filterText} comments yet.</p>`;
                return;
            }
            
            let html = '';
            filteredComments.forEach(comment => {
                const timestamp = comment.timestamp ? comment.timestamp.toDate() : new Date();
                const formattedTime = formatTime(timestamp);
                const commentClass = comment.isAi ? 'ai-comment-item' : 'human-comment-item';
                
                html += `
                    <div class="comment-item ${comment.status === 'pending' ? 'pending' : ''} ${commentClass}">
                        <div class="comment-header">
                            <div class="comment-author">${comment.name}</div>
                            <div class="comment-time">${formattedTime}</div>
                        </div>
                        <div class="comment-content">${comment.text || comment.content}</div>
                        ${comment.isAi && comment.promptType ? `<div class="comment-meta">AI Generated • Type: ${comment.promptType}</div>` : ''}
                        ${!comment.isAi ? '<div class="comment-meta">Human Generated</div>' : ''}
                        <div class="comment-actions">
                            ${comment.status === 'pending' ? `<button class="approve-btn" data-id="${comment.id}">APPROVE</button>` : ''}
                            <button class="delete-btn" data-id="${comment.id}">DELETE</button>
                        </div>
                    </div>
                `;
            });
            
            commentList.innerHTML = html;
            
            // Add event listeners to buttons
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    deleteComment(this.dataset.id);
                });
            });
            
            document.querySelectorAll('.approve-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    approveComment(this.dataset.id);
                });
            });
        }

        // Show AI analysis
        function showAIAnalysis() {
            const aiComments = allComments.filter(comment => comment.isAi);
            
            if (aiComments.length === 0) {
                aiAnalysis.innerHTML = '<p>No AI comments to analyze yet.</p>';
                aiAnalysis.style.display = 'block';
                return;
            }
            
            // Count prompt types
            const promptStats = {};
            aiComments.forEach(comment => {
                const type = comment.promptType || 'unknown';
                promptStats[type] = (promptStats[type] || 0) + 1;
            });
            
            // Generate analysis HTML
            let analysisHTML = `
                <h3>AI Comments Analysis</h3>
                <p><strong>Total AI Comments:</strong> ${aiComments.length}</p>
                <p><strong>Different Prompt Types Used:</strong> ${Object.keys(promptStats).length}</p>
                <div class="prompt-stats">
            `;
            
            Object.entries(promptStats)
                .sort(([,a], [,b]) => b - a)
                .forEach(([type, count]) => {
                    const percentage = ((count / aiComments.length) * 100).toFixed(1);
                    analysisHTML += `
                        <div class="prompt-stat">
                            <div class="prompt-type">${type.replace(/_/g, ' ')}</div>
                            <div>${count} comments (${percentage}%)</div>
                        </div>
                    `;
                });
            
            analysisHTML += '</div>';
            
            // Add recent AI comments preview
            const recentAI = aiComments.slice(0, 5);
            analysisHTML += '<h4 style="margin-top: 15px; margin-bottom: 10px;">Recent AI Comments:</h4>';
            recentAI.forEach((comment, index) => {
                analysisHTML += `<div style="margin-bottom: 8px; font-size: 13px;"><strong>${index + 1}.</strong> [${comment.promptType}] ${comment.text}</div>`;
            });
            
            aiAnalysis.innerHTML = analysisHTML;
            aiAnalysis.style.display = 'block';
        }

        // Update stats
        function updateStats() {
            const aiCount = allComments.filter(comment => comment.isAi).length;
            const pendingCount = allComments.filter(comment => comment.status === 'pending').length;
            
            document.getElementById('totalComments').textContent = allComments.length;
            document.getElementById('pendingComments').textContent = pendingCount;
            document.getElementById('aiGenerated').textContent = aiCount;
        }

        // Filter button event listeners
        showAll.addEventListener('click', function() {
            setActiveFilter('all');
            renderComments('all');
            aiAnalysis.style.display = 'none';
        });

        showAI.addEventListener('click', function() {
            setActiveFilter('ai');
            renderComments('ai');
            showAIAnalysis();
        });

        showHuman.addEventListener('click', function() {
            setActiveFilter('human');
            renderComments('human');
            aiAnalysis.style.display = 'none';
        });

        function setActiveFilter(filter) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            
            if (filter === 'all') showAll.classList.add('active');
            else if (filter === 'ai') showAI.classList.add('active');
            else if (filter === 'human') showHuman.classList.add('active');
            
            currentFilter = filter;
        }

        // Delete comment
        function deleteComment(id) {
            if (confirm('Are you sure you want to delete this comment?')) {
                db.collection('comments').doc(id).delete()
                    .then(() => {
                        loadComments(currentFilter);
                    })
                    .catch(error => {
                        console.error('Error deleting comment:', error);
                        alert(`Error deleting comment: ${error.message}`);
                    });
            }
        }

        // Approve comment
        function approveComment(id) {
            db.collection('comments').doc(id).update({
                status: 'approved'
            })
            .then(() => {
                loadComments(currentFilter);
            })
            .catch(error => {
                console.error('Error approving comment:', error);
                alert(`Error approving comment: ${error.message}`);
            });
        }

        // Format timestamp
        function formatTime(timestamp) {
            const now = new Date();
            const diffMs = now - timestamp;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min ago`;
            
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            
            return timestamp.toLocaleDateString();
        }

        // Load stats (compatibility function)
        function loadStats() {
            loadComments(currentFilter);
        }

        // Advanced AI comment generation with diversity
        async function generateAiComment(apiKey) {
            localStorage.setItem('openaiApiKey', apiKey);
            
                // Reset used prompts if we've used them all
            if (usedPrompts.length >= promptTemplates.length) {
                usedPrompts = [];
            }
            
            // Select a prompt template we haven't used recently
            const availablePrompts = promptTemplates.filter(p => !usedPrompts.includes(p.type));
            const selectedPrompt = availablePrompts[Math.floor(Math.random() * availablePrompts.length)];
            
            // Track used prompts
            usedPrompts.push(selectedPrompt.type);
            if (usedPrompts.length > promptTemplates.length / 2) {
                usedPrompts.shift(); // Remove oldest
            }
            
            // Add context from real visitor reactions
            const reactionContext = realVisitorReactions[Math.floor(Math.random() * realVisitorReactions.length)];
            
            const enhancedPrompt = `
Context: You are visiting "Collective Domain", an immersive art exhibition that creates psychological spaces similar to Gregor Schneider's work. 

Reference feeling: "${reactionContext}"

${selectedPrompt.template}

Requirements:
- Write naturally, as a real visitor would
- 1-2 sentences maximum
- No academic art jargon
- Personal and immediate
- Avoid mentioning the exhibition title directly

Your comment:`;

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4',
                    messages: [
                        { 
                            role: "system", 
                            content: "You are a museum visitor writing an immediate, honest reaction. Be authentic, vulnerable, and human. Avoid clichés and art-speak."
                        },
                        { role: "user", content: enhancedPrompt }
                    ],
                    temperature: 0.9,
                    max_tokens: 80
                })
            });
            
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error.message);
            }
            
            return {
                text: data.choices[0].message.content.trim().replace(/^["']|["']$/g, ''),
                promptType: selectedPrompt.type
            };
        }

        // Event handlers
        generatePreview.addEventListener('click', async function() {
            const apiKey = openaiApiKey.value.trim();
            if (!apiKey) {
                aiPreview.textContent = 'Please enter your OpenAI API key first';
                return;
            }
            
            generatePreview.textContent = 'GENERATING...';
            generatePreview.disabled = true;
            
            try {
                const result = await generateAiComment(apiKey);
                const randomName = visitorNames[Math.floor(Math.random() * visitorNames.length)];
                
                aiPreview.innerHTML = `
                    <strong>Preview (${result.promptType}):</strong><br>
                    <strong>${randomName}:</strong> ${result.text}
                `;
            } catch (error) {
                aiPreview.textContent = `Error: ${error.message}`;
            } finally {
                generatePreview.textContent = 'Generate Preview';
                generatePreview.disabled = false;
            }
        });

        generateBatch.addEventListener('click', async function() {
            const apiKey = openaiApiKey.value.trim();
            if (!apiKey) {
                alert('Please enter your OpenAI API key first');
                return;
            }
            
            generateBatch.textContent = 'GENERATING...';
            generateBatch.disabled = true;
            
            try {
                aiPreview.innerHTML = '<strong>Generating 5 diverse comments...</strong><br><br>';
                
                for (let i = 0; i < 5; i++) {
                    const result = await generateAiComment(apiKey);
                    const randomName = visitorNames[Math.floor(Math.random() * visitorNames.length)];
                    
                    // Add to database
                    await db.collection('comments').add({
                        name: randomName,
                        text: result.text,
                        timestamp: firebase.firestore.Timestamp.now(),
                        status: 'approved',
                        isAi: true,
                        promptType: result.promptType
                    });
                    
                    aiPreview.innerHTML += `${i + 1}. [${result.promptType}] <strong>${randomName}:</strong> ${result.text}<br><br>`;
                    
                    // Delay between generations
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
                
                aiPreview.innerHTML += '<em>All comments added successfully!</em>';
                loadComments(currentFilter);
                
            } catch (error) {
                aiPreview.textContent = `Error: ${error.message}`;
            } finally {
                generateBatch.textContent = 'Generate 5 Comments';
                generateBatch.disabled = false;
            }
        });

        // Test diversity
        testDiversity.addEventListener('click', async function() {
            const apiKey = openaiApiKey.value.trim();
            if (!apiKey) {
                alert('Please enter your OpenAI API key first');
                return;
            }
            
            testDiversity.textContent = 'TESTING...';
            testDiversity.disabled = true;
            
            try {
                aiPreview.innerHTML = '<strong>Testing diversity with 10 samples:</strong><br><br>';
                const usedTypes = new Set();
                
                for (let i = 0; i < 10; i++) {
                    const result = await generateAiComment(apiKey);
                    const randomName = visitorNames[Math.floor(Math.random() * visitorNames.length)];
                    
                    usedTypes.add(result.promptType);
                    aiPreview.innerHTML += `${i + 1}. [${result.promptType}] <strong>${randomName}:</strong> ${result.text}<br><br>`;
                    
                    await new Promise(resolve => setTimeout(resolve, 800));
                }
                
                aiPreview.innerHTML += `<em>Used ${usedTypes.size} different prompt types out of ${promptTemplates.length} available</em>`;
                
            } catch (error) {
                aiPreview.textContent = `Error: ${error.message}`;
            } finally {
                testDiversity.textContent = 'Test Diversity (10 samples)';
                testDiversity.disabled = false;
            }
        });

        // Auto-generation with randomized timing
        enableAiComments.addEventListener('click', function() {
            const apiKey = openaiApiKey.value.trim();
            if (!apiKey) {
                alert('Please enter your OpenAI API key first');
                return;
            }
            
            if (aiInterval) {
                // Disable AI comments
                clearTimeout(aiInterval);
                aiInterval = null;
                enableAiComments.textContent = 'Enable Auto Generation';
                enableAiComments.style.background = '#4CAF50';
                aiPreview.innerHTML = 'Auto-generation disabled.';
            } else {
                // Enable AI comments with randomized timing
                enableAiComments.textContent = 'Disable Auto Generation';
                enableAiComments.style.background = '#f44336';
                aiPreview.innerHTML = 'Auto-generation enabled! Comments will be generated every 15-25 minutes with high diversity.';
                
                // Generate first comment immediately
                generateAndPostAiComment();
                
                // Schedule next comment with random interval
                scheduleNextComment();
            }
        });

        // Schedule next comment with randomized timing
        function scheduleNextComment() {
            // Random interval between 15-25 minutes (900000-1500000 ms)
            const minInterval = 15 * 60 * 1000; // 15 minutes
            const maxInterval = 25 * 60 * 1000; // 25 minutes
            const randomInterval = minInterval + Math.random() * (maxInterval - minInterval);
            
            aiInterval = setTimeout(() => {
                generateAndPostAiComment();
                scheduleNextComment(); // Schedule the next one
            }, randomInterval);
            
            const nextInMinutes = Math.round(randomInterval / 60000);
            console.log(`Next AI comment scheduled in ${nextInMinutes} minutes`);
        }

        // Generate and post AI comment automatically
        async function generateAndPostAiComment() {
            const apiKey = openaiApiKey.value.trim();
            
            try {
                const result = await generateAiComment(apiKey);
                
                // Random visitor name
                const randomName = visitorNames[Math.floor(Math.random() * visitorNames.length)];
                
                // Add to database
                await db.collection('comments').add({
                    name: randomName,
                    text: result.text,
                    timestamp: firebase.firestore.Timestamp.now(),
                    status: 'approved',
                    isAi: true,
                    promptType: result.promptType
                });
                
                console.log(`Auto-generated comment (${result.promptType}):`, result.text);
                
                // Reload comments if currently viewing
                if (currentFilter !== 'human') {
                    loadComments(currentFilter);
                }
                
            } catch (error) {
                console.error('Error generating auto comment:', error);
            }
        }

        // Auto-save API key
        openaiApiKey.addEventListener('change', function() {
            localStorage.setItem('openaiApiKey', this.value);
        });
    </script>
</body>
</html>
