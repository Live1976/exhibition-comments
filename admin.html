<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>You're Live to the World - Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, system-ui, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #000;
            color: #fff;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 24px;
            font-weight: 400;
        }

        .login-section {
            background: white;
            padding: 40px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 100px auto;
        }

        .login-section h2 {
            margin-bottom: 20px;
            font-weight: 400;
            text-align: center;
        }

        .admin-panel {
            display: none;
        }

        .comment-controls {
            background: white;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-btn {
            padding: 8px 16px;
            background: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .filter-btn.active {
            background: #007cba;
            color: white;
            border-color: #007cba;
        }

        .filter-btn:hover {
            background: #e0e0e0;
        }

        .filter-btn.active:hover {
            background: #005a8b;
        }

        .ai-analysis {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #b3d9ff;
        }

        .ai-analysis h3 {
            margin-bottom: 15px;
            color: #0066cc;
        }

        .prompt-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .prompt-stat {
            background: white;
            padding: 8px 12px;
            border-radius: 3px;
            border: 1px solid #ccc;
            font-size: 12px;
        }

        .prompt-type {
            font-weight: bold;
            color: #0066cc;
        }

        .ai-comment-item {
            border-left: 4px solid #4CAF50;
        }

        .human-comment-item {
            border-left: 4px solid #2196F3;
        }

        .comment-meta {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .comment-list {
            margin-top: 20px;
        }

        .comment-item {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: relative;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .comment-author {
            font-weight: 500;
        }

        .comment-time {
            color: #999;
            font-size: 14px;
        }

        .comment-content {
            margin-bottom: 15px;
        }

        .comment-actions {
            text-align: right;
        }

        .delete-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }

        .approve-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 5px;
        }

        .pending {
            background: #fffde7;
        }

        .pending::before {
            content: "PENDING REVIEW";
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff9800;
            color: white;
            padding: 3px 8px;
            font-size: 12px;
            border-radius: 3px;
        }

        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            padding: 12px 20px;
            background: #000;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }

        .logout-btn {
            background: transparent;
            border: 1px solid white;
            width: auto;
            font-size: 14px;
            padding: 5px 10px;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .stat-number {
            font-size: 36px;
            font-weight: 300;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .ai-section {
            margin-top: 30px;
            background: white;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .ai-section h2 {
            margin-bottom: 20px;
            font-weight: 400;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .save-btn {
            width: auto;
            margin-right: 10px;
        }

        .ai-preview {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            border: 1px solid #eee;
            min-height: 50px;
        }

        .ai-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .ai-controls button {
            width: auto;
            padding: 10px 15px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .frequency-setting {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .frequency-setting h3 {
            margin-bottom: 10px;
            color: #1976d2;
        }

        .randomness-info {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .randomness-info h4 {
            color: #2e7d32;
            margin-bottom: 8px;
        }

        @media (max-width: 768px) {
            .ai-controls {
                flex-direction: column;
            }
            
            .ai-controls button {
                width: 100%;
            }
            
            .filter-buttons {
                flex-direction: column;
            }
            
            .prompt-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Section -->
    <div class="login-section" id="loginSection">
        <h2>ADMIN LOGIN</h2>
        <form id="loginForm">
            <input type="text" id="username" placeholder="Username" required>
            <input type="password" id="password" placeholder="Password" required>
            <button type="submit">LOGIN</button>
        </form>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <header>
            <h1>YOU'RE LIVE TO THE WORLD - ADMIN</h1>
            <button class="logout-btn" id="logoutBtn">LOGOUT</button>
        </header>
        
        <div class="container">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalComments">0</div>
                    <div class="stat-label">TOTAL COMMENTS</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingComments">0</div>
                    <div class="stat-label">PENDING REVIEW</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="aiGenerated">0</div>
                    <div class="stat-label">AI GENERATED</div>
                </div>
            </div>
            
            <div class="comment-controls">
                <div class="filter-buttons">
                    <button id="showAll" class="filter-btn active">Show All Comments</button>
                    <button id="showAI" class="filter-btn">AI Comments Only</button>
                    <button id="showHuman" class="filter-btn">Human Comments Only</button>
                </div>
                <div class="ai-analysis" id="aiAnalysis" style="display: none;">
                    <!-- AI analysis will appear here -->
                </div>
            </div>
            
            <div class="comment-list" id="commentList">
                <!-- Comments will be loaded here -->
            </div>
            
            <div class="ai-section">
                <h2>Enhanced AI Comment Generation System</h2>
                
                <div class="control-group">
                    <label>OpenAI API Key:</label>
                    <input type="password" id="openaiApiKey" placeholder="sk-...">
                </div>

                <div class="randomness-info">
                    <h4>Enhanced Randomness Features:</h4>
                    <p>• 20 sophisticated prompt templates (each used ~5 times)</p>
                    <p>• 35 emotional/contextual backgrounds</p>
                    <p>• 5 visitor persona types (student, professional, academic, curious public, collector)</p>
                    <p>• 6 temporal contexts (early visit, rushed viewing, etc.)</p>
                    <p>• Dynamic AI parameters (temperature 0.8-1.1, tokens 60-80)</p>
                    <p>• Total combinations: 20×35×5×6 = 21,000 unique possibilities</p>
                </div>

                <div class="frequency-setting">
                    <h3>Auto-Generation Settings</h3>
                    <p>Current: Every 15-25 minutes (3-4 comments per hour)</p>
                    <p>Exhibition Schedule: 5 days × 8 hours × ~20 comments = ~100 total comments</p>
                    <p>High diversity ensures no repetitive patterns</p>
                </div>

                <div class="ai-controls">
                    <button id="generatePreview" class="save-btn">Generate Preview</button>
                    <button id="generateBatch" class="save-btn">Generate 5 Comments</button>
                    <button id="enableAiComments" style="background: #4CAF50;">Enable Auto Generation</button>
                    <button id="testDiversity" class="save-btn">Test Diversity (10 samples)</button>
                </div>
                
                <div class="ai-preview" id="aiPreview">
                    AI-generated comments will appear here...
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC_9YXNAYdFjmqK2iNKrra76zd05Nd61Iw",
            authDomain: "exhibition-comments.firebaseapp.com",
            projectId: "exhibition-comments",
            storageBucket: "exhibition-comments.firebasestorage.app",
            messagingSenderId: "166867670609",
            appId: "1:166867670609:web:7e2009858a5e4ecd300a70",
            measurementId: "G-D89J84MCH6"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Admin credentials
        const ADMIN_USERNAME = "admin";
        const ADMIN_PASSWORD = "password123";

        // DOM elements
        const loginSection = document.getElementById('loginSection');
        const adminPanel = document.getElementById('adminPanel');
        const loginForm = document.getElementById('loginForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const commentList = document.getElementById('commentList');
        const openaiApiKey = document.getElementById('openaiApiKey');
        const generatePreview = document.getElementById('generatePreview');
        const generateBatch = document.getElementById('generateBatch');
        const enableAiComments = document.getElementById('enableAiComments');
        const testDiversity = document.getElementById('testDiversity');
        const aiPreview = document.getElementById('aiPreview');
        const showAll = document.getElementById('showAll');
        const showAI = document.getElementById('showAI');
        const showHuman = document.getElementById('showHuman');
        const aiAnalysis = document.getElementById('aiAnalysis');

        // Enhanced visitor names - more realistic contemporary art audience
        const visitorNames = [
            "Anna", "James", "Sarah", "M", "Alex", "Claire", "Tom", "L.", "Emma", "David",
            "K", "Sophie", "Ben", "R.", "Lucy", "visitor_23", "Maya", "Sam", "E.", "Chris",
            "Nina", "J.", "Zoe", "Daniel", "A.", "Rose", "Max", "F.", "Lily", "Jack",
            "Ava", "Oliver", "Grace", "P.", "Mia", "visitor_47", "Ethan", "Chloe", "H.", "Leo"
        ];

        // Visitor persona system for enhanced diversity
        const visitorPersonas = [
            { 
                type: "art_student", 
                background: "studying contemporary art, familiar with theory",
                language: "theoretical but personal"
            },
            { 
                type: "professional", 
                background: "works in creative industries, experienced gallery visitor",
                language: "informed but accessible"
            },
            { 
                type: "academic", 
                background: "teaches or researches art, critical perspective",
                language: "analytical with cultural references"
            },
            { 
                type: "curious_public", 
                background: "interested in art but not expert, open-minded",
                language: "honest and questioning"
            },
            { 
                type: "collector", 
                background: "collects contemporary art, market-aware",
                language: "evaluative with aesthetic focus"
            }
        ];

        // Temporal contexts for situational variety
        const timeContexts = [
            "early_visit", "midday_reflection", "end_of_day", 
            "repeat_visitor", "rushed_viewing", "contemplative_moment"
        ];

        // AI generation state with randomized timing
        let aiInterval = null;
        let aiGeneratedCount = 0;
        let lastPromptUsed = null;
        let usedPrompts = [];

        // Global variables for filtering
        let allComments = [];
        let currentFilter = 'all';

        // Expanded emotional/contextual backgrounds (16→35)
        const realVisitorReactions = [
            "feels like walking through someone's private memory",
            "the uncomfortable intimacy of watching domestic life",
            "caught between being a visitor and a voyeur",
            "everything looks familiar but somehow staged",
            "like peering through windows I shouldn't see",
            "the space holds its breath waiting for something",
            "domestic life as performance art",
            "boundaries between public and private dissolve here",
            "the uncanny feeling of home that isn't home",
            "surveillance made visible and visceral",
            "like being inside a social media post",
            "time feels different in these miniature worlds",
            "the scaffolding reminds me everything is constructed",
            "privacy doesn't exist in this digital fishbowl",
            "feels both intimate and completely artificial",
            "like watching life through a screen, but real",
            "the weight of being observed while observing",
            "domestic space as a stage set for invisible audiences",
            "technology making the invisible infrastructure visible",
            "the loneliness of connected life",
            "performativity of everyday actions",
            "home as both sanctuary and prison",
            "the anxiety of constant visibility",
            "miniature worlds revealing macro concerns",
            "digital life's uncanny valley",
            "the choreography of ordinary gestures",
            "surveillance capitalism made tangible",
            "the politics of domestic space",
            "intimacy mediated through technology",
            "the labor of maintaining appearances",
            "home as content production site",
            "the exhaustion of perpetual performance",
            "private life as public spectacle",
            "the architecture of attention",
            "domestic space in the age of platforms"
        ];

        // Expanded prompt templates (15→20)
        const promptTemplates = [
            {
                type: "phenomenological_observation",
                template: `You are experiencing "You're Live to the World" - an exhibition examining the transformation of domestic space in digital culture. The work features miniature domestic environments constructed on industrial scaffolding, alongside live green screen performances that blur reality and mediation.

Write a thoughtful visitor comment that engages with the phenomenology of the space - how it feels to move through and observe these constructed domestic environments. Consider the relationship between scale, intimacy, and voyeurism.`
            },
            {
                type: "digital_domesticity_reflection",
                template: `You are viewing an exhibition that interrogates how our homes have become stages for digital performance, particularly post-pandemic. The work presents domestic spaces as both intimate and public, private and performed.

Write a visitor comment that reflects on this tension between authentic domesticity and its digital representation. How does the exhibition make you think about your own relationship to home as both lived space and curated image?`
            },
            {
                type: "surveillance_recognition",
                template: `The exhibition explores themes of visibility, control, and the erosion of privacy in digital domestic spaces. You're experiencing work that makes surveillance infrastructure visible while questioning who watches whom.

Write a comment that engages with the politics of observation presented in the work. Consider how the exhibition positions you as both viewer and viewed.`
            },
            {
                type: "materiality_infrastructure",
                template: `You're observing an installation where the technical infrastructure (scaffolding, cables, screens) is deliberately visible, exposing the apparatus that usually remains hidden in digital domestic life.

Write a comment about the relationship between the physical construction of the work and its conceptual concerns about constructed domesticity.`
            },
            {
                type: "uncanny_familiarity",
                template: `The exhibition creates an uncanny experience - spaces that feel familiar yet strange, domestic yet artificial. Drawing on the tradition of artists like Gregor Schneider, it investigates the psychological dimensions of home.

Write a comment about the uncanny feelings the work generates and what this reveals about contemporary domestic experience.`
            },
            {
                type: "performance_reality",
                template: `You've witnessed live green screen performances where the artist appears to inhabit the digital domestic spaces. This blurs the boundary between live presence and mediated representation.

Write about the experience of watching someone perform domesticity in real-time, and what this suggests about how we all perform home life.`
            },
            {
                type: "scale_perspective",
                template: `The miniature scale of the domestic environments creates a specific viewing position - you become a giant observing tiny lives, which shifts your relationship to the intimate spaces being presented.

Write about how the scale affects your engagement with the work and what it reveals about power dynamics in domestic observation.`
            },
            {
                type: "social_media_critique",
                template: `The exhibition seems to critique the aestheticization of domestic life through social media platforms, where homes become content and privacy becomes performance.

Write a comment that connects the work to your own experience of domestic life in digital culture - how it relates to the homes you see and share online.`
            },
            {
                type: "temporal_disorientation",
                template: `The work creates a sense of temporal suspension - repetitive domestic actions, looping videos, the feeling that time moves differently in these constructed spaces.

Write about the temporal experience of the exhibition and how it relates to the way digital technology affects our perception of time at home.`
            },
            {
                type: "architectural_psychology",
                template: `The exhibition investigates how architectural and spatial design affects psychological experience, particularly in the context of homes that must serve multiple functions in digital culture.

Write a comment that engages with the spatial psychology of the work - how the physical environment affects your mental and emotional state.`
            },
            {
                type: "collective_individual",
                template: `The title "You're Live to the World" suggests both individual exposure and collective experience. The work examines how private domestic life becomes public performance in digital culture.

Write about the tension between individual privacy and collective visibility that the exhibition explores.`
            },
            {
                type: "labor_domesticity",
                template: `The exhibition touches on how domestic labor has become increasingly visible and monetized through digital platforms, transforming private maintenance into public performance.

Write a comment that considers the relationship between domestic work and digital visibility presented in the exhibition.`
            },
            {
                type: "authenticity_simulation",
                template: `The work questions what constitutes authentic domestic experience when our homes are increasingly mediated through digital technologies and platforms.

Write about the relationship between authentic and simulated domesticity that you observe in the exhibition.`
            },
            {
                type: "intimacy_distance",
                template: `The exhibition creates paradoxical experiences of intimacy and distance - you're close to domestic spaces but they're miniaturized; you observe intimate actions but they're performed.

Write about this paradox of intimate distance and what it suggests about contemporary relationships to home and privacy.`
            },
            {
                type: "technological_mediation",
                template: `The work explicitly shows the technological apparatus (screens, cables, green screen technology) that mediates contemporary domestic experience, making visible what is usually invisible.

Write a comment about the role of technology in mediating domestic experience and how the exhibition reveals this typically hidden infrastructure.`
            },
            // NEW TEMPLATES (16-20)
            {
                type: "visitor_demographic_specific",
                template: `As someone with your particular background and relationship to contemporary art, you're experiencing this exhibition through your own lens of understanding and expectation.

Write a comment that reflects your specific perspective and how your background influences your reading of the work's themes around digital domesticity and surveillance.`
            },
            {
                type: "comparative_reference",
                template: `This exhibition reminds you of other contemporary artists or cultural phenomena you've encountered that deal with similar themes of privacy, domesticity, and digital culture.

Write a comment that draws connections between this work and other artists, exhibitions, or cultural references that come to mind.`
            },
            {
                type: "emotional_vulnerability",
                template: `The exhibition has triggered something personal in you - a recognition, a discomfort, a memory, or an emotional response that goes beyond intellectual engagement.

Write a comment that expresses this more vulnerable, personal reaction to the work and what it reveals about your own life.`
            },
            {
                type: "technical_curiosity",
                template: `You find yourself curious about the technical aspects of the work - how the green screen technology works, how the miniature environments are constructed, how the digital systems operate.

Write a comment that explores this fascination with the technical implementation and what it reveals about the relationship between technology and domestic life.`
            },
            {
                type: "cultural_commentary",
                template: `The exhibition makes you think about broader cultural and political issues beyond the gallery walls - about capitalism, social media, surveillance, pandemic life, or contemporary society.

Write a comment that connects the work to these larger cultural concerns and what it suggests about the world we're living in.`
            }
        ];

        // Login functionality
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                loginSection.style.display = 'none';
                adminPanel.style.display = 'block';
                loadComments();
                
                // Load saved API key
                const savedApiKey = localStorage.getItem('openaiApiKey');
                if (savedApiKey) {
                    openaiApiKey.value = savedApiKey;
                }
            } else {
                alert('Invalid credentials');
            }
        });

        // Logout functionality
        logoutBtn.addEventListener('click', function() {
            loginSection.style.display = 'block';
            adminPanel.style.display = 'none';
            document.getElementById('loginForm').reset();
        });

        // Load comments with filtering capability
        function loadComments(filter = 'all') {
            db.collection('comments')
                .orderBy('timestamp', 'desc')
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        commentList.innerHTML = '<p style="text-align: center; padding: 20px;">No comments yet.</p>';
                        return;
                    }
                    
                    // Store all comments
                    allComments = [];
                    snapshot.forEach(doc => {
                        allComments.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Apply filter and render
                    renderComments(filter);
                    updateStats();
                    
                    if (filter === 'ai') {
                        showAIAnalysis();
                    } else {
                        aiAnalysis.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error loading comments:', error);
                    commentList.innerHTML = `<p>Error loading comments: ${error.message}</p>`;
                });
        }

        // Render comments based on filter
        function renderComments(filter) {
            let filteredComments = allComments;
            
            if (filter === 'ai') {
                filteredComments = allComments.filter(comment => comment.isAi);
            } else if (filter === 'human') {
                filteredComments = allComments.filter(comment => !comment.isAi);
            }
            
            if (filteredComments.length === 0) {
                const filterText = filter === 'ai' ? 'AI' : filter === 'human' ? 'human' : '';
                commentList.innerHTML = `<p style="text-align: center; padding: 20px;">No ${filterText} comments yet.</p>`;
                return;
            }
            
            let html = '';
            filteredComments.forEach(comment => {
                const timestamp = comment.timestamp ? comment.timestamp.toDate() : new Date();
                const formattedTime = formatTime(timestamp);
                const commentClass = comment.isAi ? 'ai-comment-item' : 'human-comment-item';
                
                html += `
                    <div class="comment-item ${comment.status === 'pending' ? 'pending' : ''} ${commentClass}">
                        <div class="comment-header">
                            <div class="comment-author">${comment.name}</div>
                            <div class="comment-time">${formattedTime}</div>
                        </div>
                        <div class="comment-content">${comment.text || comment.content}</div>
                        ${comment.isAi && comment.promptType ? `<div class="comment-meta">AI Generated • Type: ${comment.promptType.replace(/_/g, ' ')} • Persona: ${comment.visitorPersona || 'unknown'}</div>` : ''}
                        ${!comment.isAi ? '<div class="comment-meta">Human Generated</div>' : ''}
                        <div class="comment-actions">
                            ${comment.status === 'pending' ? `<button class="approve-btn" data-id="${comment.id}">APPROVE</button>` : ''}
                            <button class="delete-btn" data-id="${comment.id}">DELETE</button>
                        </div>
                    </div>
                `;
            });
            
            commentList.innerHTML = html;
            
            // Add event listeners to buttons
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    deleteComment(this.dataset.id);
                });
            });
            
            document.querySelectorAll('.approve-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    approveComment(this.dataset.id);
                });
            });
        }

        // Show AI analysis
        function showAIAnalysis() {
            const aiComments = allComments.filter(comment => comment.isAi);
            
            if (aiComments.length === 0) {
                aiAnalysis.innerHTML = '<p>No AI comments to analyze yet.</p>';
                aiAnalysis.style.display = 'block';
                return;
            }
            
            // Count prompt types
            const promptStats = {};
            const personaStats = {};
            aiComments.forEach(comment => {
                const type = comment.promptType || 'unknown';
                const persona = comment.visitorPersona || 'unknown';
                promptStats[type] = (promptStats[type] || 0) + 1;
                personaStats[persona] = (personaStats[persona] || 0) + 1;
            });
            
            // Generate analysis HTML
            let analysisHTML = `
                <h3>Enhanced AI Comments Analysis</h3>
                <p><strong>Total AI Comments:</strong> ${aiComments.length}</p>
                <p><strong>Different Prompt Types Used:</strong> ${Object.keys(promptStats).length}</p>
                <p><strong>Different Personas Used:</strong> ${Object.keys(personaStats).length}</p>
                <div class="prompt-stats">
            `;
            
            Object.entries(promptStats)
                .sort(([,a], [,b]) => b - a)
                .forEach(([type, count]) => {
                    const percentage = ((count / aiComments.length) * 100).toFixed(1);
                    analysisHTML += `
                        <div class="prompt-stat">
                            <div class="prompt-type">${type.replace(/_/g, ' ')}</div>
                            <div>${count} comments (${percentage}%)</div>
                        </div>
                    `;
                });
            
            analysisHTML += '</div><h4 style="margin-top: 15px;">Visitor Personas Distribution:</h4><div class="prompt-stats">';
            
            Object.entries(personaStats)
                .sort(([,a], [,b]) => b - a)
                .forEach(([persona, count]) => {
                    const percentage = ((count / aiComments.length) * 100).toFixed(1);
                    analysisHTML += `
                        <div class="prompt-stat">
                            <div class="prompt-type">${persona.replace(/_/g, ' ')}</div>
                            <div>${count} comments (${percentage}%)</div>
                        </div>
                    `;
                });
            
            analysisHTML += '</div>';
            
            // Add recent AI comments preview
            const recentAI = aiComments.slice(0, 5);
            analysisHTML += '<h4 style="margin-top: 15px; margin-bottom: 10px;">Recent AI Comments:</h4>';
            recentAI.forEach((comment, index) => {
                analysisHTML += `<div style="margin-bottom: 8px; font-size: 13px;"><strong>${index + 1}.</strong> [${comment.promptType}|${comment.visitorPersona}] ${comment.text}</div>`;
            });
            
            aiAnalysis.innerHTML = analysisHTML;
            aiAnalysis.style.display = 'block';
        }

        // Update stats
        function updateStats() {
            const aiCount = allComments.filter(comment => comment.isAi).length;
            const pendingCount = allComments.filter(comment => comment.status === 'pending').length;
            
            document.getElementById('totalComments').textContent = allComments.length;
            document.getElementById('pendingComments').textContent = pendingCount;
            document.getElementById('aiGenerated').textContent = aiCount;
        }

        // Filter button event listeners
        showAll.addEventListener('click', function() {
            setActiveFilter('all');
            renderComments('all');
            aiAnalysis.style.display = 'none';
        });

        showAI.addEventListener('click', function() {
            setActiveFilter('ai');
            renderComments('ai');
            showAIAnalysis();
        });

        showHuman.addEventListener('click', function() {
            setActiveFilter('human');
            renderComments('human');
            aiAnalysis.style.display = 'none';
        });

        function setActiveFilter(filter) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            
            if (filter === 'all') showAll.classList.add('active');
            else if (filter === 'ai') showAI.classList.add('active');
            else if (filter === 'human') showHuman.classList.add('active');
            
            currentFilter = filter;
        }

        // Delete comment
        function deleteComment(id) {
            if (confirm('Are you sure you want to delete this comment?')) {
                db.collection('comments').doc(id).delete()
                    .then(() => {
                        loadComments(currentFilter);
                    })
                    .catch(error => {
                        console.error('Error deleting comment:', error);
                        alert(`Error deleting comment: ${error.message}`);
                    });
            }
        }

        // Approve comment
        function approveComment(id) {
            db.collection('comments').doc(id).update({
                status: 'approved'
            })
            .then(() => {
                loadComments(currentFilter);
            })
            .catch(error => {
                console.error('Error approving comment:', error);
                alert(`Error approving comment: ${error.message}`);
            });
        }

        // Format timestamp
        function formatTime(timestamp) {
            const now = new Date();
            const diffMs = now - timestamp;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min ago`;
            
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            
            return timestamp.toLocaleDateString();
        }

        // Load stats (compatibility function)
        function loadStats() {
            loadComments(currentFilter);
        }

        // Enhanced AI comment generation with multi-layer randomness
        async function generateAiComment(apiKey) {
            localStorage.setItem('openaiApiKey', apiKey);
            
            // Ensure prompt diversity
            if (usedPrompts.length >= promptTemplates.length) {
                usedPrompts = [];
            }
            
            const availablePrompts = promptTemplates.filter(p => !usedPrompts.includes(p.type));
            const selectedPrompt = availablePrompts[Math.floor(Math.random() * availablePrompts.length)];
            
            usedPrompts.push(selectedPrompt.type);
            if (usedPrompts.length > promptTemplates.length / 2) {
                usedPrompts.shift();
            }
            
            // Multi-layer randomness selection
            const reactionContext = realVisitorReactions[Math.floor(Math.random() * realVisitorReactions.length)];
            const selectedPersona = visitorPersonas[Math.floor(Math.random() * visitorPersonas.length)];
            const timeContext = timeContexts[Math.floor(Math.random() * timeContexts.length)];
            
            // Dynamic AI parameters for additional randomness
            const dynamicTemperature = 0.8 + (Math.random() * 0.3); // 0.8-1.1
            const dynamicMaxTokens = 60 + Math.floor(Math.random() * 20); // 60-80
            
            const enhancedPrompt = `
Context: You are visiting "You're Live to the World" at the Royal College of Art. This is a sophisticated contemporary art exhibition examining digital domesticity, surveillance culture, and the transformation of private space into public performance, particularly in the post-pandemic era.

Visitor Profile: You are a ${selectedPersona.background}. Your perspective is shaped by ${selectedPersona.language} approach to art.

Situational Context: This is a ${timeContext.replace(/_/g, ' ')} - consider how this timing affects your energy and attention.

The exhibition features:
- Miniature domestic environments constructed on industrial scaffolding by Luca George
- Live green screen performances by Yaqi Sun exploring mediated domesticity
- Commentary on social media's transformation of home into content
- Investigation of privacy, surveillance, and digital infrastructure

Current feeling/observation: "${reactionContext}"

${selectedPrompt.template}

Guidelines for your response:
- Write from your specific visitor perspective (${selectedPersona.type})
- Use ${selectedPersona.language} language
- Consider the ${timeContext} context in your tone and focus
- 1-2 sentences maximum
- Be specific about what you're observing rather than making generic art statements
- Connect the work to broader cultural experience without being didactic
- Use present tense and personal perspective
- Avoid art jargon like "explores themes" or "challenges notions"

Your comment:`;

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4',
                    messages: [
                        { 
                            role: "system", 
                            content: `You are writing a visitor comment for a contemporary art exhibition. Write as a ${selectedPersona.type} who ${selectedPersona.background}. Use ${selectedPersona.language} style. Be thoughtful, observant, and personal. Avoid clichés, art-speak, and overly casual language. Your response should sound like an intelligent person genuinely responding to challenging contemporary art.`
                        },
                        { role: "user", content: enhancedPrompt }
                    ],
                    temperature: dynamicTemperature,
                    max_tokens: dynamicMaxTokens,
                    presence_penalty: 0.3,
                    frequency_penalty: 0.3
                })
            });
            
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error.message);
            }
            
            return {
                text: data.choices[0].message.content.trim().replace(/^["']|["']$/g, ''),
                promptType: selectedPrompt.type,
                visitorPersona: selectedPersona.type,
                timeContext: timeContext,
                reactionContext: reactionContext
            };
        }

        // Event handlers
        generatePreview.addEventListener('click', async function() {
            const apiKey = openaiApiKey.value.trim();
            if (!apiKey) {
                aiPreview.textContent = 'Please enter your OpenAI API key first';
                return;
            }
            
            generatePreview.textContent = 'GENERATING...';
            generatePreview.disabled = true;
            
            try {
                const result = await generateAiComment(apiKey);
                const randomName = visitorNames[Math.floor(Math.random() * visitorNames.length)];
                
                aiPreview.innerHTML = `
                    <strong>Preview:</strong><br>
                    <strong>Type:</strong> ${result.promptType.replace(/_/g, ' ')}<br>
                    <strong>Persona:</strong> ${result.visitorPersona.replace(/_/g, ' ')}<br>
                    <strong>Context:</strong> ${result.timeContext.replace(/_/g, ' ')}<br>
                    <strong>${randomName}:</strong> ${result.text}
                `;
            } catch (error) {
                aiPreview.textContent = `Error: ${error.message}`;
            } finally {
                generatePreview.textContent = 'Generate Preview';
                generatePreview.disabled = false;
            }
        });

        generateBatch.addEventListener('click', async function() {
            const apiKey = openaiApiKey.value.trim();
            if (!apiKey) {
                alert('Please enter your OpenAI API key first');
                return;
            }
            
            generateBatch.textContent = 'GENERATING...';
            generateBatch.disabled = true;
            
            try {
                aiPreview.innerHTML = '<strong>Generating 5 diverse comments...</strong><br><br>';
                
                for (let i = 0; i < 5; i++) {
                    const result = await generateAiComment(apiKey);
                    const randomName = visitorNames[Math.floor(Math.random() * visitorNames.length)];
                    
                    // Add to database
                    await db.collection('comments').add({
                        name: randomName,
                        text: result.text,
                        timestamp: firebase.firestore.Timestamp.now(),
                        status: 'approved',
                        isAi: true,
                        promptType: result.promptType,
                        visitorPersona: result.visitorPersona,
                        timeContext: result.timeContext,
                        reactionContext: result.reactionContext
                    });
                    
                    aiPreview.innerHTML += `${i + 1}. [${result.promptType.replace(/_/g, ' ')}|${result.visitorPersona.replace(/_/g, ' ')}] <strong>${randomName}:</strong> ${result.text}<br><br>`;
                    
                    // Delay between generations
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
                
                aiPreview.innerHTML += '<em>All comments added successfully!</em>';
                loadComments(currentFilter);
                
            } catch (error) {
                aiPreview.textContent = `Error: ${error.message}`;
            } finally {
                generateBatch.textContent = 'Generate 5 Comments';
                generateBatch.disabled = false;
            }
        });

        // Test diversity
        testDiversity.addEventListener('click', async function() {
            const apiKey = openaiApiKey.value.trim();
            if (!apiKey) {
                alert('Please enter your OpenAI API key first');
                return;
            }
            
            testDiversity.textContent = 'TESTING...';
            testDiversity.disabled = true;
            
            try {
                aiPreview.innerHTML = '<strong>Testing enhanced diversity with 10 samples:</strong><br><br>';
                const usedTypes = new Set();
                const usedPersonas = new Set();
                
                for (let i = 0; i < 10; i++) {
                    const result = await generateAiComment(apiKey);
                    const randomName = visitorNames[Math.floor(Math.random() * visitorNames.length)];
                    
                    usedTypes.add(result.promptType);
                    usedPersonas.add(result.visitorPersona);
                    aiPreview.innerHTML += `${i + 1}. [${result.promptType.replace(/_/g, ' ')}|${result.visitorPersona.replace(/_/g, ' ')}] <strong>${randomName}:</strong> ${result.text}<br><br>`;
                    
                    await new Promise(resolve => setTimeout(resolve, 1200));
                }
                
                aiPreview.innerHTML += `<em>Used ${usedTypes.size} different prompt types and ${usedPersonas.size} different personas out of ${promptTemplates.length} templates and ${visitorPersonas.length} personas available</em>`;
                
            } catch (error) {
                aiPreview.textContent = `Error: ${error.message}`;
            } finally {
                testDiversity.textContent = 'Test Diversity (10 samples)';
                testDiversity.disabled = false;
            }
        });

        // Auto-generation with randomized timing
        enableAiComments.addEventListener('click', function() {
            const apiKey = openaiApiKey.value.trim();
            if (!apiKey) {
                alert('Please enter your OpenAI API key first');
                return;
            }
            
            if (aiInterval) {
                // Disable AI comments
                clearTimeout(aiInterval);
                aiInterval = null;
                enableAiComments.textContent = 'Enable Auto Generation';
                enableAiComments.style.background = '#4CAF50';
                aiPreview.innerHTML = 'Auto-generation disabled.';
            } else {
                // Enable AI comments with randomized timing
                enableAiComments.textContent = 'Disable Auto Generation';
                enableAiComments.style.background = '#f44336';
                aiPreview.innerHTML = 'Enhanced auto-generation enabled! Comments will be generated every 15-25 minutes with maximum diversity using 20 templates, 5 personas, and 35 emotional contexts.';
                
                // Generate first comment immediately
                generateAndPostAiComment();
                
                // Schedule next comment with random interval
                scheduleNextComment();
            }
        });

        // Schedule next comment with randomized timing
        function scheduleNextComment() {
            // Random interval between 15-25 minutes (900000-1500000 ms)
            const minInterval = 15 * 60 * 1000; // 15 minutes
            const maxInterval = 25 * 60 * 1000; // 25 minutes
            const randomInterval = minInterval + Math.random() * (maxInterval - minInterval);
            
            aiInterval = setTimeout(() => {
                generateAndPostAiComment();
                scheduleNextComment(); // Schedule the next one
            }, randomInterval);
            
            const nextInMinutes = Math.round(randomInterval / 60000);
            console.log(`Next AI comment scheduled in ${nextInMinutes} minutes`);
        }

        // Generate and post AI comment automatically
        async function generateAndPostAiComment() {
            const apiKey = openaiApiKey.value.trim();
            
            try {
                const result = await generateAiComment(apiKey);
                
                // Random visitor name
                const randomName = visitorNames[Math.floor(Math.random() * visitorNames.length)];
                
                // Add to database with enhanced metadata
                await db.collection('comments').add({
                    name: randomName,
                    text: result.text,
                    timestamp: firebase.firestore.Timestamp.now(),
                    status: 'approved',
                    isAi: true,
                    promptType: result.promptType,
                    visitorPersona: result.visitorPersona,
                    timeContext: result.timeContext,
                    reactionContext: result.reactionContext
                });
                
                console.log(`Auto-generated comment (${result.promptType}|${result.visitorPersona}):`, result.text);
                
                // Reload comments if currently viewing
                if (currentFilter !== 'human') {
                    loadComments(currentFilter);
                }
                
            } catch (error) {
                console.error('Error generating auto comment:', error);
            }
        }

        // Auto-save API key
        openaiApiKey.addEventListener('change', function() {
            localStorage.setItem('openaiApiKey', this.value);
        });
    </script>
</body>
</html>
